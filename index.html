<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini site</title>

  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 32px; }

    .box {
      max-width: 520px;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 16px;
      position: relative;
      z-index: 1;
      background: white;
    }

    input#answer {
      width: 100%;
      padding: 14px;
      font-size: 18px;
      border: 2px solid #bbb;
      border-radius: 12px;
      outline: none;
      box-sizing: border-box;
      transition: border-color 150ms, box-shadow 150ms;
    }

    .ok input#answer { border-color: #1a7f37; box-shadow: 0 0 18px rgba(26,127,55,.35); }
    .bad input#answer { border-color: #d1242f; box-shadow: 0 0 18px rgba(209,36,47,.25); }

    .msg { margin-top: 14px; font-size: 18px; min-height: 26px; }
    .hint { margin-top: 10px; font-size: 14px; color: #666; }

    #fx { position: fixed; inset: 0; pointer-events: none; z-index: 9998; display: none; }
    #confetti { position: fixed; inset: 0; pointer-events: none; overflow: hidden; z-index: 9999; display: none; }

    .confetto {
      position: absolute;
      top: -12px;
      width: 10px;
      height: 14px;
      opacity: 0.95;
      animation-name: confettiFall;
      animation-timing-function: linear;
      animation-fill-mode: forwards;
    }

    @keyframes confettiFall {
      to { transform: translateY(110vh) rotate(540deg); opacity: 0.25; }
    }

    .winCard {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) scale(0.92);
      opacity: 0;
      pointer-events: none;
      z-index: 10000;
      transition: 220ms ease;
      background: rgba(255,255,255,0.92);
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 18px;
      padding: 12px;
      max-width: min(420px, 84vw);
      box-shadow: 0 18px 60px rgba(0,0,0,0.22);
    }
    .winCard.show {
  pointer-events: auto;
}

    .winCard.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    .winCard img { display: block; width: 100%; height: auto; border-radius: 14px; }

    .winText {
      margin: 14px 6px 4px;
      font-size: 18px;
      line-height: 1.4;
      text-align: center;
      color: #111;
    }

    #leaderboard { margin-top: 16px; padding-left: 20px; font-size: 16px; }
    #leaderboard li { margin-bottom: 6px; }

    /* Modal (popup pr√©nom) */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 20000;
    }
    .modal.hidden { display: none; }

    .modal-box {
      background: white;
      padding: 20px;
      border-radius: 14px;
      width: min(320px, 90%);
      text-align: center;
      box-shadow: 0 12px 40px rgba(0,0,0,0.25);
    }

    .modal-box input {
      width: 100%;
      padding: 10px;
      margin-top: 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      font-size: 16px;
    }

    .modal-actions {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      margin-top: 14px;
    }

    .modal-actions button {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-size: 15px;
    }

    #confirmBtn { background: #22c55e; color: white; }
    #skipBtn { background: #e5e7eb; }

    /* Croix pour fermer la winCard */
    .close-win {
      position: absolute;
      top: 8px;
      right: 10px;
      background: transparent;
      border: none;
      font-size: 22px;
      font-weight: bold;
      cursor: pointer;
      color: #444;
      line-height: 1;
    }
    .close-win:hover { color: #000; }
  </style>
</head>

<body>
  <h1>Entre la r√©ponse</h1>

  <div class="box" id="wrap">
    <input
      id="answer"
      type="text"
      placeholder="Tape ta r√©ponse puis appuie sur ENTER"
      autocomplete="off"
    />
    <div class="msg" id="msg"></div>
    <div class="hint">Validation uniquement avec la touche ENTER</div>
  </div>

  <h2>Ils ont trouv√© üëá</h2>
  <ol id="leaderboard"></ol>

  <canvas id="fx"></canvas>
  <div id="confetti"></div>

  <div id="winCard" class="winCard" aria-hidden="true">
    <button id="closeWinCard" class="close-win" aria-label="Fermer" type="button">√ó</button>
    <img id="winImg" alt="Bravo" />
    <p class="winText">Un pr√©nom est r√©v√©l√©. Une autre √©toile reste √† nommer.</p>
  </div>

  <!-- POPUP PRENOM -->
  <div id="nameModal" class="modal hidden">
    <div class="modal-box">
      <p>Bravo üéâ Quel est ton pr√©nom ?</p>
      <input
        id="playerNameInput"
        type="text"
        placeholder="Entre ton pr√©nom"
        maxlength="30"
      />
      <div class="modal-actions">
        <button id="skipBtn" type="button">Passer</button>
        <button id="confirmBtn" type="button">Valider</button>
      </div>
    </div>
  </div>

  <!-- SCRIPT PRINCIPAL (jeu + modal) -->
  <script>
    const SECRET = "DIANE";
    const WIN_IMAGE_SRC = "img/etoiles.jpg";

    const wrap = document.getElementById("wrap");
    const input = document.getElementById("answer");
    const msg = document.getElementById("msg");

    const fxCanvas = document.getElementById("fx");
    const fxCtx = fxCanvas.getContext("2d");
    const confettiLayer = document.getElementById("confetti");
    const winCard = document.getElementById("winCard");
    const winImg = document.getElementById("winImg");

    // Croix de fermeture winCard (‚ö†Ô∏è NE PAS red√©clarer winCard)
    const closeWinBtn = document.getElementById("closeWinCard");
    closeWinBtn.addEventListener("click", () => {
      winCard.classList.remove("show");
      winCard.setAttribute("aria-hidden", "true");
      input.focus();
    });

    // Modal elements
    const modal = document.getElementById("nameModal");
    const nameInput = document.getElementById("playerNameInput");
    const confirmBtn = document.getElementById("confirmBtn");
    const skipBtn = document.getElementById("skipBtn");

    let solved = false;
    let nameAsked = false;

    function openNameModal() {
      nameInput.value = "";
      modal.classList.remove("hidden");
      nameInput.focus();
    }

    function closeNameModal() {
      modal.classList.add("hidden");
    }

    confirmBtn.addEventListener("click", () => {
      const name = nameInput.value.trim();
      if (name && window.__addWinner) window.__addWinner(name);
      closeNameModal();
      input.focus();
    });

    skipBtn.addEventListener("click", () => {
      closeNameModal();
      input.focus();
    });

    // Enter dans le champ pr√©nom = valider
    nameInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        confirmBtn.click();
      }
    });

    function resizeFx() {
      fxCanvas.width = window.innerWidth;
      fxCanvas.height = window.innerHeight;
    }
    window.addEventListener("resize", resizeFx);
    resizeFx();

    function normalize(text) {
      return (text || "").trim().toUpperCase();
    }

    function resetState() {
      wrap.classList.remove("ok", "bad");
      msg.textContent = "";
    }

    const failureMessages = [
      "Pas encore, mais tu peux r√©essayer üôÇ",
      "Ce n‚Äôest pas la bonne r√©ponse, continue !",
      "Presque‚Ä¶ enfin pas encore üòâ",
      "Rat√© cette fois, mais ne l√¢che pas.",
      "Ce n‚Äôest pas √ßa, essaie autrement.",
      "Mauvaise r√©ponse, mais tu es sur la bonne voie.",
      "Non, mais rien n‚Äôest perdu !",
      "Ce n‚Äôest pas correct pour l‚Äôinstant.",
      "Pas exactement, retente ta chance.",
      "Dommage‚Ä¶ mais la solution existe üòâ"
    ];

    function randomFailureMessage() {
      return failureMessages[Math.floor(Math.random() * failureMessages.length)];
    }

    function showWinCard() {
      winImg.src = WIN_IMAGE_SRC;
      winCard.classList.add("show");
      winCard.setAttribute("aria-hidden", "false");
    }

    function launchConfetti(durationMs = 3600) {
      confettiLayer.innerHTML = "";
      confettiLayer.style.display = "block";

      const colors = ["#22c55e", "#16a34a", "#f97316", "#eab308", "#3b82f6", "#a855f7", "#ef4444"];
      const start = Date.now();

      function spawnBatch() {
        if (Date.now() - start > durationMs) {
          setTimeout(() => {
            confettiLayer.style.display = "none";
            confettiLayer.innerHTML = "";
          }, 1200);
          return;
        }

        for (let i = 0; i < 14; i++) {
          const c = document.createElement("div");
          c.className = "confetto";
          const size = 6 + Math.random() * 10;
          c.style.width = size + "px";
          c.style.height = size * 1.4 + "px";
          c.style.left = Math.random() * 100 + "vw";
          c.style.background = colors[Math.floor(Math.random() * colors.length)];
          c.style.animationDuration = 1100 + Math.random() * 1700 + "ms";
          c.style.animationDelay = Math.random() * 120 + "ms";
          confettiLayer.appendChild(c);
          setTimeout(() => c.remove(), 2200);
        }

        requestAnimationFrame(spawnBatch);
      }

      requestAnimationFrame(spawnBatch);
    }

    function launchFireworks(durationMs = 3200) {
      fxCanvas.style.display = "block";
      const particles = [];
      const start = performance.now();

      function rand(a, b) { return a + Math.random() * (b - a); }

      function burst() {
        const x = rand(fxCanvas.width * 0.15, fxCanvas.width * 0.85);
        const y = rand(fxCanvas.height * 0.12, fxCanvas.height * 0.45);
        for (let i = 0; i < 60; i++) {
          particles.push({
            x, y,
            vx: Math.cos(Math.random() * Math.PI * 2) * rand(2, 6),
            vy: Math.sin(Math.random() * Math.PI * 2) * rand(2, 6),
            life: 60,
            size: rand(1.2, 2.6),
            h: Math.random() * 360
          });
        }
      }

      let last = 0;

      function tick(t) {
        const elapsed = t - start;
        fxCtx.fillStyle = "rgba(0,0,0,0.18)";
        fxCtx.fillRect(0, 0, fxCanvas.width, fxCanvas.height);

        if (elapsed < durationMs && t - last > 200) {
          burst();
          last = t;
        }

        for (let i = particles.length - 1; i >= 0; i--) {
          const p = particles[i];
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.06;
          p.life--;

          fxCtx.fillStyle = `hsla(${p.h},95%,60%,${p.life / 60})`;
          fxCtx.beginPath();
          fxCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
          fxCtx.fill();

          if (p.life <= 0) particles.splice(i, 1);
        }

        if (elapsed > durationMs && particles.length === 0) {
          fxCanvas.style.display = "none";
          fxCtx.clearRect(0, 0, fxCanvas.width, fxCanvas.height);
          return;
        }

        requestAnimationFrame(tick);
      }

      requestAnimationFrame(tick);
    }

    function celebrateWin() {
      launchFireworks(3200);
      launchConfetti(3600);
      setTimeout(showWinCard, 3600);

      // Afficher le popup imm√©diatement apr√®s la r√©ussite (une seule fois)
      if (!nameAsked) {
        nameAsked = true;
        openNameModal();
      }
    }

    function checkAnswer() {
      const value = normalize(input.value);
      if (!value) return;

      if (value === normalize(SECRET)) {
        if (solved) return;
        solved = true;

        wrap.classList.remove("bad");
        wrap.classList.add("ok");
        msg.textContent = "üéâ Bravo, tu as trouv√© la bonne r√©ponse !";

        celebrateWin();
      } else {
        wrap.classList.remove("ok");
        wrap.classList.add("bad");
        msg.textContent = randomFailureMessage();
      }
    }

    // ‚úÖ ENTER fiabilis√©
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        checkAnswer();
        return;
      }
      if (!solved) resetState();
    });

    input.focus();
  </script>

  <!-- SCRIPT FIREBASE (module) EN DERNIER -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      query,
      orderBy,
      limit,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCyTkLaV66fWGgzEipwUmTGA1ztE5qM9t4",
      authDomain: "enigmes-prenom.firebaseapp.com",
      projectId: "enigmes-prenom",
      storageBucket: "enigmes-prenom.firebasestorage.app",
      messagingSenderId: "601585511460",
      appId: "1:601585511460:web:29bc1ce97113c934f83cb1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const leaderboard = document.getElementById("leaderboard");

    function render(list) {
      if (!leaderboard) return;
      leaderboard.innerHTML = "";
      list.forEach(item => {
        const li = document.createElement("li");
        const d = item.foundAt?.toDate?.();
        li.textContent = `${item.name} ‚Äî ${d ? d.toLocaleString("fr-FR") : ""}`;
        leaderboard.appendChild(li);
      });
    }

    async function loadWinners() {
      const q = query(
        collection(db, "winners"),
        orderBy("foundAt", "desc"),
        limit(13)
      );
      const snap = await getDocs(q);
      render(snap.docs.map(doc => doc.data()));
    }

    async function addWinner(name) {
      const clean = (name || "").trim().slice(0, 30);
      if (!clean) return;

      await addDoc(collection(db, "winners"), {
        name: clean,
        foundAt: serverTimestamp()
      });

      await loadWinners();
    }

    window.__addWinner = addWinner;
    loadWinners();
  </script>
</body>
</html>
